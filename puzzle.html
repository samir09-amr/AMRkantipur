<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AMR & Dengue Crossword — Login + Live CSV</title>
<style>
  :root{--blue:#2b6cb0;--muted:#6c757d;--card:#fff;--bg:#f6fbff}
  body{font-family:Inter,Segoe UI,Roboto,Arial; background:var(--bg); margin:0; padding:18px; color:#1f2937}
  .wrap{max-width:980px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  h1{margin:0;font-size:20px;color:var(--blue)}
  .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(10,20,40,0.06);margin-bottom:14px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  label{display:block;font-weight:600;margin-bottom:6px;font-size:13px}
  input[type=text],input[type=email],select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef6;font-size:14px}
  .row{display:flex;gap:8px}
  .row > div{flex:1}
  .btn{background:var(--blue);color:#fff;padding:10px 12px;border-radius:8px;border:0;cursor:pointer}
  .btn.gray{background:#f3f4f6;color:#111;border:1px solid #e6eef6}
  .timer{font-weight:700;background:#fff7ed;color:#d97706;padding:6px 10px;border-radius:999px}
  table.cross{border-collapse:collapse;margin:12px auto}
  table.cross td{width:34px;height:34px;border:1px solid #dbeafe;vertical-align:middle;padding:0;position:relative}
  .black{background:#0f172a;border-color:#0f172a}
  input.cell{width:100%;height:100%;border:0;font-weight:700;font-size:18px;text-transform:uppercase;text-align:center;background:#ffffff;border:1px solid #cbd5e1;box-shadow:inset 0 2px 4px rgba(0,0,0,0.05)}
  .clues{max-height:420px;overflow:auto;padding-right:6px}
  ol{margin:6px 0 0 18px;padding:0}
  .small{font-size:13px;color:#475569}
  .resultBox{display:flex;gap:12px;align-items:center;justify-content:space-between}
  .ok{background:#dcfce7}
  .bad{background:#fee2e2}
  .notice{background:#fff3cd;border-radius:8px;padding:10px;color:#7c4a02}
  footer{margin-top:18px;font-size:13px;color:#475569}
  .hidden{display:none}
  .admin-btn{position:fixed;right:16px;top:14px;padding:8px 10px;border-radius:10px;border:0;background:#111827;color:#fff;z-index:1200}
  .center{text-align:center}
  .clue-number{position:absolute;top:1px;left:1px;font-size:8px;color:#64748b;font-weight:bold;z-index:1}
  .clues-container{display:flex;gap:20px;margin-top:20px}
  .clues-section{flex:1}
  .clues-section h3{margin-top:0;color:var(--blue)}
  .score-display{font-size:18px;font-weight:bold;color:var(--blue);margin-top:15px;padding:10px;background:#f1f7ff;border-radius:8px;text-align:center}
</style>
</head>
<body>
  <button id="adminAccessBtn" class="admin-btn" title="Admin - CSV upload & leaderboard">Admin</button>

  <div class="wrap">
    <header><h1>AMR & Dengue Crossword</h1><div class="small">Login → Puzzle (questions load from your sheet)</div></header>

    <!-- LOGIN / REGISTRATION CARD (first view) -->
    <section class="card" id="loginCard">
      <h3 style="margin-top:0">Player Registration</h3>
      <div class="row" style="margin-bottom:8px">
        <div><label>Name *</label><input id="playerName" type="text" placeholder="Full name" required></div>
        <div><label>Email</label><input id="email" type="email" placeholder="you@example.com"></div>
        <div><label>Contact</label><input id="contact" type="text" placeholder="9801xxxxx"></div>
      </div>
      <div class="row" style="margin-bottom:8px">
        <div><label>School</label><input id="schoolName" type="text" placeholder="School name"></div>
        <div><label>Class</label><input id="className" type="text" placeholder="Class / Grade"></div>
        <div><label>Parent Name</label><input id="parentName" type="text" placeholder="Parent / Guardian"></div>
      </div>
      <div class="row" style="margin-bottom:12px">
        <div><label>Parent Contact</label><input id="parentContact" type="text" placeholder="984xxxxxxxx"></div>
        <div><label>Club / Organization (if any)</label><input id="clubName" type="text" placeholder="AMR Club"></div>
        <div style="align-self:end"><button id="loginSubmitBtn" class="btn">Continue to Puzzle</button></div>
      </div>
      <div class="small">Required: Name. The rest are optional but will be saved to the sheet on submit.</div>
    </section>

    <!-- PUZZLE + CLUES (hidden until login) -->
    <div id="puzzleArea" class="hidden">
      <section class="card" id="gameCard">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Crossword</strong></div>
          <div style="display:flex;gap:10px;align-items:center">
            <div class="timer" id="timerDisplay">00:00</div>
            <button id="checkAnswersBtn" class="btn gray">Check</button>
            <button id="submitGameBtn" class="btn">Submit</button>
          </div>
        </div>

        <div id="crosswordGrid" style="text-align:center;margin-top:10px"></div>

        <div id="solutionBox" style="display:none;margin-top:12px">
          <strong>Solution</strong>
          <div id="solutionGrid"></div>
        </div>
      </section>

      <!-- Clues section moved below the puzzle -->
      <section class="card">
        <h3 style="margin-top:0">Clues</h3>
        <div class="clues-container">
          <div class="clues-section">
            <h3>Across</h3>
            <div class="clues"><ol id="acrossList"></ol></div>
          </div>
          <div class="clues-section">
            <h3>Down</h3>
            <div class="clues"><ol id="downList"></ol></div>
          </div>
        </div>
      </section>

      <!-- Score display after completion -->
      <div class="score-display hidden" id="scoreDisplay">
        Your Score: <span id="scoreValue">0</span>%
      </div>
    </div>

    <footer>
      <div class="small">Questions load from this CSV: <code>https://docs.google.com/spreadsheets/d/e/2PACX-1vR5Tas63fCeJ1ytgiL5-Hy8qLh4UMvtxuC-i1MJgQMQNcsr7pZnVe7ycY55MplwkWq7q9r2IGw5s6JW/pub?output=csv</code>. If fetch fails, defaults are used.</div>
      <div class="small" style="margin-top:6px">To enable Sheets saving: paste your Apps Script web app /exec URL into the <code>SHEETS_WEBAPP_URL</code> variable in the script below.</div>
    </footer>
  </div>

<script>
/* ================== CONFIG ================== */
/* Paste your Apps Script web app URL here if you want spreadsheet saving.
   Example: "https://script.google.com/macros/s/AKfycbx.../exec" */
const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzkXZ3EeMva4FXVtT-2umBPNSCwfsNP6cO351QXey03b8dHAzTwZXpVhTpr3PNkzH-Sgg/exec";

/* CSV URL provided by you (the published CSV) */
const QUESTIONS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR5Tas63fCeJ1ytgiL5-Hy8qLh4UMvtxuC-i1MJgQMQNcsr7pZnVe7ycY55MplwkWq7q9r2IGw5s6JW/pub?output=csv";

/* persistent keys */
const QKEY = 'amr_crossword_questions_v2';
const LBKEY = 'amr_crossword_leaderboard_v2';

/* UI refs */
const $ = id => document.getElementById(id);
const loginCard = $('loginCard');
const loginSubmitBtn = $('loginSubmitBtn');
const puzzleArea = $('puzzleArea');
const crosswordGrid = $('crosswordGrid');
const acrossList = $('acrossList');
const downList = $('downList');
const timerDisplay = $('timerDisplay');
const checkAnswersBtn = $('checkAnswersBtn');
const submitGameBtn = $('submitGameBtn');
const solutionBox = $('solutionBox');
const solutionGrid = $('solutionGrid');
const adminBtn = $('adminAccessBtn');
const scoreDisplay = $('scoreDisplay');
const scoreValue = $('scoreValue');

/* state */
let state = {
  N: 15,
  grid: [],
  placements: [],
  startTime: null,
  timerInterval: null,
  timeElapsed: 0,
  score: 0,
  words: [],
  clueNumbers: {} // To store clue numbers for each word
};

/* small helpers */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function pad(n){ return String(n).padStart(2,'0'); }
function formatTime(sec){ return `${pad(Math.floor(sec/60))}:${pad(sec%60)}`; }

/* default questions fallback */
const DEFAULT_QUESTIONS = [
  {word:"ANTIBIOTIC", clue:"Medicines used to prevent and treat bacterial infections"},
  {word:"RESISTANCE", clue:"The ability of bacteria to withstand antibiotics"},
  {word:"MOSQUITO", clue:"Insect that transmits dengue virus"},
  {word:"AEDES", clue:"Genus of mosquito that spreads dengue"},
  {word:"FEVER", clue:"A common symptom of dengue"},
  {word:"VECTOR", clue:"An organism that transmits disease"},
  {word:"VACCINE", clue:"A biological preparation that provides immunity"},
  {word:"SANITATION", clue:"Essential to prevent mosquito breeding"},
  {word:"HYDRATION", clue:"Important treatment during dengue"}
];

/* ================== CSV load & parse ================== */
/* Try fetch the published CSV. If fails, use local storage or defaults.
   CSV expected columns: Word,Clue (headers included) */
async function fetchQuestionsFromCSV(){
  try{
    const res = await fetch(QUESTIONS_CSV_URL, {cache:'no-store'});
    if(!res.ok) throw new Error('CSV fetch failed');
    const text = await res.text();
    const lines = text.split(/\r?\n/).filter(Boolean);
    if(lines.length < 2) throw new Error('CSV appears empty or has no data');
    const headers = lines[0].split(',').map(h=>h.trim().toLowerCase());
    const wIdx = headers.findIndex(h => h.includes('word'));
    const cIdx = headers.findIndex(h => h.includes('clue'));
    if(wIdx === -1 || cIdx === -1) throw new Error('CSV missing Word/Clue headers');
    const arr = [];
    for(let i=1;i<lines.length;i++){
      const cols = splitCsvRow(lines[i]);
      const w = (cols[wIdx] || '').trim();
      const c = (cols[cIdx] || '').trim();
      if(!w || !c) continue;
      // normalize
      arr.push({ word: w.toUpperCase().replace(/[^A-Z]/g,''), clue: c });
    }
    if(arr.length === 0) throw new Error('No valid rows in CSV');
    // save to localStorage for offline reuse
    localStorage.setItem(QKEY, JSON.stringify(arr));
    console.log('Questions loaded from CSV:', arr.length);
    return arr;
  }catch(err){
    console.warn('CSV fetch error:', err);
    // fallback to any stored questions or defaults
    const stored = localStorage.getItem(QKEY);
    if(stored){
      try{ return JSON.parse(stored); } catch(e){}
    }
    console.log('Using default questions');
    localStorage.setItem(QKEY, JSON.stringify(DEFAULT_QUESTIONS));
    return DEFAULT_QUESTIONS.slice();
  }
}

/* split CSV row with basic support for quoted commas */
function splitCsvRow(row){
  const out = [];
  let cur = '', inQuotes = false;
  for(let i=0;i<row.length;i++){
    const ch = row[i];
    if(ch === '"' ) { inQuotes = !inQuotes; continue; }
    if(ch === ',' && !inQuotes){ out.push(cur); cur = ''; continue; }
    cur += ch;
  }
  out.push(cur);
  return out;
}

/* ================== Crossword placement algorithm (favor DOWN & balance) ================== */
/* Algorithm strategy:
   - Sort words by length desc
   - Decide a target for DOWN words: prefer more DOWN than ACROSS (ceil(60% of words) but ensure balance)
   - Try placements giving priority to DOWN until target reached, then across
   - Try multiple attempts (randomized) to fit maximum words
*/

function createEmptyGrid(N){
  const g=[];
  for(let r=0;r<N;r++){ g[r]=[]; for(let c=0;c<N;c++) g[r][c]=null; }
  return g;
}

function canPlace(word, r, c, dir, grid){
  const L = word.length;
  const N = grid.length;
  if(dir === 'across'){
    if(c + L > N) return false;
    // adjacent checks: ensure not connecting wrongly
    if(c>0 && grid[r][c-1]) return false;
    if(c+L < N && grid[r][c+L]) return false;
    for(let i=0;i<L;i++){
      const ch = grid[r][c+i];
      if(ch && ch !== word[i]) return false;
      // ensure above/below not conflict with adjacent non-overlap letters
      if(!ch){
        if(r>0 && grid[r-1][c+i] && grid[r-1][c+i] !== word[i]) {/* ok */}
        if(r+1 < N && grid[r+1][c+i] && grid[r+1][c+i] !== word[i]) {/* ok */}
      }
    }
    return true;
  } else {
    if(r + L > N) return false;
    if(r>0 && grid[r-1][c]) return false;
    if(r+L < N && grid[r+L][c]) return false;
    for(let i=0;i<L;i++){
      const ch = grid[r+i][c];
      if(ch && ch !== word[i]) return false;
      if(!ch){
        if(c>0 && grid[r+i][c-1] && grid[r+i][c-1] !== word[i]) {/* ok */}
        if(c+1 < N && grid[r+i][c+1] && grid[r+i][c+1] !== word[i]) {/* ok */}
      }
    }
    return true;
  }
}

/* attempt to place word at random positions, return placement or null */
function tryPlaceWordRandom(word, grid, preferDir){
  const N = grid.length;
  const dirs = preferDir === 'down' ? ['down','across'] : ['across','down'];
  for(let attempt=0; attempt<300; attempt++){
    const dir = dirs[Math.floor(Math.random()*dirs.length)];
    const r = Math.floor(Math.random()*N);
    const c = Math.floor(Math.random()*N);
    if(canPlace(word, r, c, dir, grid)){
      // place it
      if(dir === 'across'){
        for(let i=0;i<word.length;i++) grid[r][c+i] = word[i];
      } else {
        for(let i=0;i<word.length;i++) grid[r+i][c] = word[i];
      }
      return {row:r, col:c, dir, word};
    }
  }
  return null;
}

/* main builder: tries multiple layouts and returns best fit */
function buildCrossword(words, N=15){
  // words: array of {word, clue}
  const cleaned = words.map(w=>({word: (w.word||'').toUpperCase().replace(/[^A-Z]/g,''), clue: w.clue||''}))
                        .filter(w=>w.word && w.word.length <= N);
  // sort by length desc
  cleaned.sort((a,b)=>b.word.length - a.word.length);

  // decide target down count: prefer down heavier (60% or ceil)
  const total = cleaned.length || 1;
  const targetDown = Math.ceil(total * 0.60);

  let best = {placed:[], grid:createEmptyGrid(N), score: -1};

  // try multiple randomized builds and keep the one with most words placed and better down/across balance
  for(let attempt=0; attempt<18; attempt++){
    const grid = createEmptyGrid(N);
    const placed = [];
    let downCount = 0, acrossCount = 0;
    for(let i=0;i<cleaned.length;i++){
      const entry = cleaned[i];
      // choose preferDir: if downCount < targetDown prefer down, else across
      const preferDir = downCount < targetDown ? 'down' : 'across';
      const p = tryPlaceWordRandom(entry.word, grid, preferDir);
      if(p){
        p.clue = entry.clue;
        placed.push(p);
        if(p.dir === 'down') downCount++; else acrossCount++;
      }
    }
    // score primary: number of placed words, secondary: how close downCount to targetDown, tertiary: fewer empty cells
    const placedCount = placed.length;
    const downDelta = Math.abs(targetDown - downCount);
    // count letters placed
    let letters=0; for(let r=0;r<N;r++) for(let c=0;c<N;c++) if(grid[r][c]) letters++;
    const score = placedCount*100 - downDelta*2 + Math.floor(letters/10);
    if(score > best.score){
      best = {placed, grid, score, downCount, acrossCount, letters};
    }
  }

  // finalize: number assignment not needed (we won't print numbers). Return placements with length.
  best.placed.forEach(p => p.length = p.word.length);
  return {grid: best.grid, placements: best.placed};
}

/* ================== Rendering (with numbers for clues) ================== */
function renderGrid(grid, placements){
  crosswordGrid.innerHTML = '';
  const tbl = document.createElement('table');
  tbl.className = 'cross';
  const tbody = document.createElement('tbody');
  tbl.appendChild(tbody);
  
  // Generate clue numbers
  state.clueNumbers = {};
  let clueCounter = 1;
  
  for(let r=0;r<grid.length;r++){
    const tr = document.createElement('tr');
    for(let c=0;c<grid[0].length;c++){
      const td = document.createElement('td');
      if(!grid[r][c]){
        td.className = 'black';
      } else {
        // Check if this cell should have a clue number (start of a word)
        let hasClueNumber = false;
        for(const p of placements){
          if(p.row === r && p.col === c){
            state.clueNumbers[`${r}-${c}`] = clueCounter;
            hasClueNumber = true;
            break;
          }
        }
        
        if(hasClueNumber){
          const clueNumSpan = document.createElement('span');
          clueNumSpan.className = 'clue-number';
          clueNumSpan.textContent = clueCounter++;
          td.appendChild(clueNumSpan);
        }
        
        const input = document.createElement('input');
        input.setAttribute('maxlength','1');
        input.className = 'cell';
        input.dataset.r = r; input.dataset.c = c;
        input.dataset.solution = grid[r][c];
        input.addEventListener('input', function(e){
          this.value = (this.value||'').toUpperCase().replace(/[^A-Z]/g,'').slice(0,1);
        });
        // keyboard navigation
        input.addEventListener('keydown', handleArrowNav);
        td.appendChild(input);
      }
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
  crosswordGrid.appendChild(tbl);

  // render clues lists with numbers
  const across = [], down = [];
  placements.forEach(p => {
    if(p.dir === 'across') across.push(p);
    else down.push(p);
  });
  across.sort((a,b)=>a.row - b.row || a.col - b.col);
  down.sort((a,b)=>a.col - b.col || a.row - b.row);

  acrossList.innerHTML = '';
  downList.innerHTML = '';
  
  // Render across clues with numbers
  across.forEach((p, i) => {
    const clueNum = state.clueNumbers[`${p.row}-${p.col}`] || (i + 1);
    const li = document.createElement('li');
    li.innerHTML = `<strong>${clueNum}.</strong> ${escapeHtml(p.clue)} (${p.length})`;
    acrossList.appendChild(li);
  });
  
  // Render down clues with numbers
  down.forEach((p, i) => {
    const clueNum = state.clueNumbers[`${p.row}-${p.col}`] || (i + 1);
    const li = document.createElement('li');
    li.innerHTML = `<strong>${clueNum}.</strong> ${escapeHtml(p.clue)} (${p.length})`;
    downList.appendChild(li);
  });
}

/* keyboard arrow navigation (left/right/up/down) */
function handleArrowNav(e){
  const key = e.key;
  if(!['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Tab','Backspace','Enter'].includes(key)) return;
  const r = parseInt(this.dataset.r), c = parseInt(this.dataset.c);
  function focusCell(rr, cc){
    const selector = `input.cell[data-r="${rr}"][data-c="${cc}"]`;
    const el = document.querySelector(selector);
    if(el) el.focus();
  }
  if(key === 'ArrowLeft'){ focusCell(r, c-1); e.preventDefault(); }
  else if(key === 'ArrowRight'){ focusCell(r, c+1); e.preventDefault(); }
  else if(key === 'ArrowUp'){ focusCell(r-1, c); e.preventDefault(); }
  else if(key === 'ArrowDown'){ focusCell(r+1, c); e.preventDefault(); }
  else if(key === 'Enter'){ focusCell(r+1, c); e.preventDefault(); }
}

/* show solution as filled readonly grid */
function renderSolution(grid){
  solutionGrid.innerHTML = '';
  const tbl = document.createElement('table'); tbl.className='cross';
  const tbody = document.createElement('tbody'); tbl.appendChild(tbody);
  for(let r=0;r<grid.length;r++){
    const tr = document.createElement('tr');
    for(let c=0;c<grid[0].length;c++){
      const td = document.createElement('td');
      if(!grid[r][c]) td.className='black';
      else td.textContent = grid[r][c];
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
  solutionGrid.appendChild(tbl);
}

/* ================== Timer & scoring ================== */
function startTimer(){
  state.startTime = Date.now();
  state.timeElapsed = 0;
  timerDisplay.textContent = '00:00';
  state.timerInterval = setInterval(()=> {
    state.timeElapsed = Math.floor((Date.now() - state.startTime)/1000);
    timerDisplay.textContent = formatTime(state.timeElapsed);
  }, 1000);
}
function stopTimer(){
  if(state.timerInterval) clearInterval(state.timerInterval);
  state.timerInterval = null;
}

/* count correct letters and score */
function checkAnswers(mark){
  const inputs = Array.from(document.querySelectorAll('input.cell'));
  let total=0, correct=0;
  inputs.forEach(inp => {
    const sol = inp.dataset.solution || '';
    if(!sol) return;
    total++;
    const val = (inp.value || '').toUpperCase();
    if(val === sol){ correct++; if(mark) inp.style.background = '#dcfce7'; }
    else { if(mark) inp.style.background = '#fee2e2'; }
  });
  const percent = total ? Math.round((correct/total)*100) : 0;
  state.score = percent;
  return {percent, correct, total};
}

/* ================== Save to Google Sheet (Apps Script endpoint) ================== */
function sendToSheet(payload){
  if(!SHEETS_WEBAPP_URL || SHEETS_WEBAPP_URL.includes('REPLACE_WITH')) {
    console.warn('SHEETS_WEBAPP_URL not set — skipping push to Google Sheets.');
    return Promise.resolve({status:'skipped'});
  }
  return fetch(SHEETS_WEBAPP_URL, {
    method:'POST',
    mode:'cors',
    headers:{'Content-Type':'text/plain'},
    body: JSON.stringify(payload)
  }).then(res => {
    if(res.ok) return res.json().catch(()=> ({status:'success'}));
    return res.text().then(t => ({status:'error', message:t}));
  }).catch(err=>{
    console.warn('CORS failed, trying no-cors fallback', err);
    return fetch(SHEETS_WEBAPP_URL, { method:'POST', mode:'no-cors', body: JSON.stringify(payload) })
      .then(()=> ({status:'success (no-cors)'})).catch(e => ({status:'error', message: e.toString()}));
  });
}

/* ================== Submit flow ================== */
async function submitGame(){
  const name = $('playerName').value.trim();
  if(!name){ alert('Name is required.'); return; }
  stopTimer();
  const res = checkAnswers(true);
  state.timeElapsed = state.timeElapsed || Math.floor((Date.now() - state.startTime)/1000);

  const payload = {
    name: name,
    email: $('email').value.trim(),
    school: $('schoolName').value.trim(),
    class: $('className').value.trim(),
    parentName: $('parentName').value.trim(),
    parentContact: $('parentContact').value.trim(),
    club: $('clubName').value.trim(),
    score: res.percent,
    time: state.timeElapsed,
    date: new Date().toISOString()
  };

  // Show score display
  scoreValue.textContent = res.percent;
  scoreDisplay.classList.remove('hidden');

  // attempt sheet push
  const push = await sendToSheet(payload);
  console.log('sheet push:', push);
}

/* ================== Build + UI wiring ================== */
async function initAndShowPuzzle(){
  const questions = await fetchQuestionsFromCSV();
  state.words = questions.slice();
  // choose grid size adaptively: larger if many long words
  const maxLen = Math.max(...questions.map(q=>q.word.length), 8);
  state.N = Math.max(12, Math.min(18, maxLen + 4));
  // build crossword
  const cw = buildCrossword(state.words, state.N);
  state.grid = cw.grid;
  state.placements = cw.placements;
  renderGrid(state.grid, state.placements);
  renderSolution(state.grid);
  startTimer();
  // focus first cell
  setTimeout(()=> {
    const first = document.querySelector('input.cell');
    if(first) first.focus();
  }, 250);
}

/* login flow: on registration submit hide login and run puzzle setup */
loginSubmitBtn.addEventListener('click', async ()=>{
  const name = $('playerName').value.trim();
  if(!name){ alert('Please enter your name'); return; }
  // save registration to localStorage for persistence
  const reg = {
    name, email: $('email').value.trim(), contact: $('contact').value.trim(),
    school: $('schoolName').value.trim(), class: $('className').value.trim(),
    parentName: $('parentName').value.trim(), parentContact: $('parentContact').value.trim(),
    club: $('clubName').value.trim(), date: new Date().toISOString()
  };
  localStorage.setItem('amr_player_reg', JSON.stringify(reg));
  // show puzzle area and hide login
  loginCard.classList.add('hidden');
  puzzleArea.classList.remove('hidden');
  // initialize puzzle (fetch CSV etc)
  await initAndShowPuzzle();
});

/* check, submit, play again wiring */
checkAnswersBtn.addEventListener('click', ()=> {
  const r = checkAnswers(true);
  alert(`Checked: ${r.correct}/${r.total} letters correct — ${r.percent}%`);
});
submitGameBtn.addEventListener('click', submitGame);

/* simple admin: allow paste CSV or load defaults */
adminBtn.addEventListener('click', async ()=>{
  const choice = prompt('Admin options:\n1 = Reload questions from published CSV\n2 = Paste CSV text\n3 = Load default sample questions\nCancel to close', '1');
  if(!choice) return;
  if(choice.trim() === '1'){
    // force refetch by removing cached QKEY then reload puzzle if currently visible
    localStorage.removeItem(QKEY);
    alert('Reloading from published CSV. If failure occurs, defaults will be used.');
    if(!loginCard.classList.contains('hidden')) return;
    await initAndShowPuzzle();
  } else if(choice.trim()==='2'){
    const csv = prompt('Paste CSV text (headers Word,Clue).');
    if(!csv) return;
    // parse and save
    const lines = csv.split(/\r?\n/).filter(Boolean);
    if(lines.length < 2){ alert('CSV looks too small'); return; }
    const headers = lines[0].split(',').map(h=>h.trim().toLowerCase());
    const wIdx = headers.findIndex(h=>h.includes('word'));
    const cIdx = headers.findIndex(h=>h.includes('clue'));
    if(wIdx<0 || cIdx<0){ alert('Missing Word/Clue headers'); return; }
    const arr = [];
    for(let i=1;i<lines.length;i++){
      const cols = splitCsvRow(lines[i]);
      const w = (cols[wIdx]||'').trim();
      const c = (cols[cIdx]||'').trim();
      if(w && c) arr.push({word: w.toUpperCase().replace(/[^A-Z]/g,''), clue: c});
    }
    if(arr.length === 0){ alert('No valid rows found'); return; }
    localStorage.setItem(QKEY, JSON.stringify(arr));
    alert('Questions saved locally. Reloading puzzle.');
    if(!loginCard.classList.contains('hidden')) return;
    await initAndShowPuzzle();
  } else if(choice.trim()==='3'){
    localStorage.setItem(QKEY, JSON.stringify(DEFAULT_QUESTIONS));
    alert('Default questions loaded.');
    if(!loginCard.classList.contains('hidden')) return;
    await initAndShowPuzzle();
  }
});

/* on load restore registration details */
(function boot(){
  const reg = localStorage.getItem('amr_player_reg');
  if(reg){
    try{
      const r = JSON.parse(reg);
      $('playerName').value = r.name || '';
      $('email').value = r.email || '';
      $('contact').value = r.contact || '';
      $('schoolName').value = r.school || '';
      $('className').value = r.class || '';
      $('parentName').value = r.parentName || '';
      $('parentContact').value = r.parentContact || '';
      $('clubName').value = r.club || '';
    }catch(e){}
  }
})();
</script>
</body>
</html>
