<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3041015200590330"
     crossorigin="anonymous"></script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AMR & Dengue Crossword Puzzle</title>
<style>
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 980px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f0f8ff;
        color: #333;
    }
    .section {
        background-color: white;
        padding: 25px;
        margin-bottom: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    h1,h2 { text-align:center; }
    h1 { color:#2980b9; font-size:2.2em; }

    /* admin floating button */
    .admin-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #34495e;
        color: #fff;
        border: none;
        padding: 10px 15px;
        border-radius: 6px;
        cursor: pointer;
        z-index: 1200;
    }

    /* overlay + modal */
    .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.35);
        backdrop-filter: blur(6px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1100;
    }
    .overlay.show { display:flex; }

    .modal {
        width: 760px;
        max-width: calc(100% - 40px);
        background: linear-gradient(180deg,#fff,#fbfdff);
        border-radius: 12px;
        padding: 18px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.25);
        position: relative;
    }

    .modal h3 { margin-top:0; }
    .close-x {
        position: absolute;
        right: 12px;
        top: 8px;
        background: transparent;
        border: none;
        font-size: 20px;
        cursor: pointer;
    }

    .admin-form, .admin-controls {
        display:flex; flex-direction:column; gap:10px;
    }

    .file-upload input[type=file] {
        padding:8px; border-radius:6px; border:1px dashed #3498db; width:100%;
    }

    .manual-rows { display:flex; flex-direction:column; gap:8px; max-height:220px; overflow:auto; padding-right:6px; }

    .manual-row { display:flex; gap:8px; align-items:center; }
    .manual-row input { padding:8px; border-radius:6px; border:1px solid #ddd; font-size:14px; }
    .manual-row input[type=text]{ width: 32%; }
    .manual-row input[type=select]{ width: 22%; }

    .small { font-size:13px; padding:8px 10px; border-radius:6px; }

    /* leaderboard table */
    #adminLeaderboard { width:100%; border-collapse:collapse; max-height:220px; overflow:auto; display:block; }
    #adminLeaderboard th, #adminLeaderboard td { border:1px solid #ddd; padding:8px; text-align:left; background:#fff; }
    #adminLeaderboard th { background:#3498db; color:#fff; position:sticky; top:0; }

    /* kept your crossword cell styles (copied) */
    table.crossword { border-collapse:collapse; margin:18px auto; }
    table.crossword td { width:35px; height:35px; border:1px solid #ddd; text-align:center; vertical-align:middle; position:relative; }
    .black { background:#34495e; }
    .number { position:absolute; top:1px; left:2px; font-size:9px; color:#2c3e50; font-weight:bold; }

    input.cell { width:100%; height:100%; border:none; text-align:center; font-size:18px; font-weight:bold; text-transform:uppercase; background:transparent; }

    .hidden { display:none; }
    .timer { font-weight:bold; color:#e74c3c; background:#fdedec; padding:8px 12px; border-radius:20px; }

    /* download button group */
    .btn { background:#3498db; color:white; border:none; padding:10px 12px; border-radius:6px; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .btn.secondary { background:#6c757d; }

    /* login form styles */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }
    .form-group {
        display: flex;
        flex-direction: column;
    }
    .form-group label {
        font-weight: 600;
        margin-bottom: 5px;
    }
    .form-group input, .form-group select {
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ddd;
        font-size: 14px;
    }

    /* small responsiveness */
    @media (max-width:700px) {
        .manual-row input[type=text]{ width: 100%; }
        .manual-row { flex-direction:column; align-items:stretch; }
        .form-grid {
            grid-template-columns: 1fr;
        }
    }

</style>
</head>
<body>
    <button id="adminAccessBtn" class="admin-btn">Admin Login</button>

    <!-- overlay + floating admin modal -->
    <div id="overlay" class="overlay" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
            <button class="close-x" id="closeModal">&times;</button>
            <h3 id="adminTitle">Admin Portal</h3>

            <!-- Login block -->
            <div id="loginBlock" class="admin-form">
                <input id="adminUsername" placeholder="Username" class="small" />
                <input id="adminPassword" placeholder="Password" type="password" class="small" />
                <div style="display:flex; gap:8px;">
                    <button id="adminLoginBtn" class="btn">Login</button>
                    <button id="closeLogin" class="btn secondary">Cancel</button>
                </div>
            </div>

            <!-- Controls shown after login -->
            <div id="adminControls" class="admin-controls hidden" style="margin-top:12px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <strong>Admin Panel</strong>
                    <div style="display:flex; gap:8px;">
                        <button id="adminViewLeaderboard" class="btn small">View Leaderboard</button>
                        <button id="downloadAnimBtn" class="btn small">Download Animated Leaderboard</button>
                        <button id="adminLogoutBtn" class="btn small secondary">Logout</button>
                    </div>
                </div>

                <!-- CSV upload -->
                <div class="file-upload" style="margin-top:8px;">
                    <label style="font-weight:600;">Upload Questions CSV</label>
                    <input id="csvUpload" type="file" accept=".csv" />
                    <div style="display:flex; gap:8px; margin-top:6px;">
                        <button id="uploadCsvBtn" class="btn">Upload CSV</button>
                        <button id="clearQuestionsBtn" class="btn secondary">Clear Questions</button>
                    </div>
                    <small style="color:#666;">CSV headers: Word,Clue,Difficulty (optional),Category (optional)</small>
                </div>

                <!-- Manual add rows -->
                <div style="margin-top:6px;">
                    <label style="font-weight:600;">Add Questions Manually</label>
                    <div class="manual-rows" id="manualRows"></div>
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <button id="addRowBtn" class="btn small">Add another</button>
                        <button id="saveManualBtn" class="btn small">Save Questions</button>
                    </div>
                </div>

                <!-- Leaderboard view -->
                <div id="leaderboardArea" class="hidden" style="margin-top:10px;">
                    <label style="font-weight:600;">Leaderboard</label>
                    <div style="max-height:220px; overflow:auto; border:1px solid #eee; border-radius:6px; padding:6px; background:#fafafa;">
                        <table id="adminLeaderboard"><thead><tr><th>#</th><th>Name</th><th>Club</th><th>Score</th><th>Time</th><th>Date</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Section -->
    <div class="section" id="loginSection">
        <h1>AMR & Dengue Crossword Challenge</h1>
        <p style="text-align: center; margin-bottom: 20px;">Please login to participate in the crossword puzzle challenge</p>
        
        <form id="loginForm">
            <div class="form-grid">
                <div class="form-group">
                    <label for="loginName">Full Name *</label>
                    <input type="text" id="loginName" required>
                </div>
                <div class="form-group">
                    <label for="loginEmail">Email Address *</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="schoolName">School/College Name *</label>
                    <input type="text" id="schoolName" required>
                </div>
                <div class="form-group">
                    <label for="schoolAddress">School/College Address *</label>
                    <input type="text" id="schoolAddress" required>
                </div>
                <div class="form-group">
                    <label for="classStudying">Class/Year Studying *</label>
                    <input type="text" id="classStudying" required>
                </div>
                <div class="form-group">
                    <label for="parentName">Parent/Guardian Name *</label>
                    <input type="text" id="parentName" required>
                </div>
                <div class="form-group">
                    <label for="parentContact">Parent/Guardian Contact *</label>
                    <input type="text" id="parentContact" required>
                </div>
                <div class="form-group">
                    <label for="clubName">Club/Organization (if any)</label>
                    <input type="text" id="clubName">
                </div>
            </div>
            
            <div style="text-align:center; margin-top:20px;">
                <button type="button" id="loginBtn" class="btn">Login & Continue</button>
            </div>
        </form>
    </div>

    <!-- Registration Section -->
    <div class="section hidden" id="registrationSection">
        <h1>AMR & Dengue Crossword Challenge</h1>
        <div id="quizStatus" style="text-align:center; margin-bottom:12px; color:#2ecc71;">Loading quiz...</div>
        <form id="registrationForm">
            <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center;">
                <div><label style="display:block;font-weight:600">Name</label><input id="playerName" type="text" readonly /></div>
                <div><label style="display:block;font-weight:600">Club/Organization</label><input id="playerClub" type="text" readonly /></div>
                <div><label style="display:block;font-weight:600">Email</label><input id="playerEmail" type="email" readonly /></div>
                <div><label style="display:block;font-weight:600">School</label><input id="playerSchool" type="text" readonly /></div>
            </div>
            <div style="text-align:center; margin-top:12px;">
                <button type="button" id="startGameBtn" class="btn">Start Game</button>
            </div>
        </form>
    </div>

    <!-- Game Section -->
    <div class="section hidden" id="gameSection">
        <h2>AMR & Dengue Crossword Puzzle</h2>
        <div style="text-align:center; margin-bottom:10px;">Time: <span id="timer" class="timer">00:00</span></div>
        <div id="crosswordGrid"></div>
        <div style="display:flex; gap:12px; margin-top:12px; flex-wrap:wrap;">
            <div style="flex:1; min-width:260px;">
                <h3>Across</h3>
                <ol id="acrossClues"></ol>
            </div>
            <div style="flex:1; min-width:260px;">
                <h3>Down</h3>
                <ol id="downClues"></ol>
            </div>
        </div>
        <div style="text-align:center; margin-top:12px;">
            <button id="checkAnswersBtn" class="btn">Check Answers</button>
            <button id="submitGameBtn" class="btn secondary">Submit Answers</button>
        </div>
    </div>

    <!-- Results Section -->
    <div class="section hidden" id="resultsSection">
        <h2>Game Results</h2>
        <div id="playerResult" style="margin-bottom:12px;"></div>
        <div id="solutionBox" style="display:none; margin-bottom:12px;">
            <h3>Puzzle Solution</h3>
            <div id="solutionGrid"></div>
        </div>

        <h3>Leaderboard</h3>
        <table id="leaderboard" style="width:100%; border-collapse:collapse; margin-bottom:12px;">
            <thead><tr style="background:#3498db; color:#fff;"><th>Rank</th><th>Name</th><th>Club</th><th>Score</th><th>Time</th><th>Date</th></tr></thead>
            <tbody id="leaderboardBody"></tbody>
        </table>
        <div style="text-align:center;">
            <button id="playAgainBtn" class="btn">Play Again</button>
        </div>
    </div>

    <!-- Include GIF.js from CDN for animation export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>

<script>
/* ---------------------- config & state ---------------------- */
const config = {
    adminCredentials: { username: "admin", password: "amrdengue2023" },
    questionsKey: "crosswordQuestions",
    leaderboardKey: "crosswordLeaderboard",
    loginDataKey: "crosswordLoginData",
    loginRecordsKey: "crosswordLoginRecords",
    submissionRecordsKey: "crosswordSubmissionRecords", // NEW: Separate key for submission records
    gridSize: 15,
    spreadsheetId: "1Zs1fOWhoiyhZmVZL5IRSzmhFB0t-NaCucYfriwtLqD8",
    scriptURL: "https://script.google.com/macros/library/d/1ORXef_2X_LLMdML1-4qoMJhlDHFe8VRoIERlaSkLBik5E4CSbMDiJ7Hh/2"
};

let gameState = {
    player: {},
    crossword: {},
    startTime: null,
    timerInterval: null,
    timeElapsed: 0,
    score: 0,
    checked: false,
    words: [],
    loginData: {}
};

/* ---------------------- element refs ---------------------- */
const el = {
    adminAccessBtn: document.getElementById('adminAccessBtn'),
    overlay: document.getElementById('overlay'),
    closeModal: document.getElementById('closeModal'),
    loginBlock: document.getElementById('loginBlock'),
    adminControls: document.getElementById('adminControls'),
    adminUsername: document.getElementById('adminUsername'),
    adminPassword: document.getElementById('adminPassword'),
    adminLoginBtn: document.getElementById('adminLoginBtn'),
    adminLogoutBtn: document.getElementById('adminLogoutBtn'),
    csvUpload: document.getElementById('csvUpload'),
    uploadCsvBtn: document.getElementById('uploadCsvBtn'),
    clearQuestionsBtn: document.getElementById('clearQuestionsBtn'),
    addRowBtn: document.getElementById('addRowBtn'),
    manualRows: document.getElementById('manualRows'),
    saveManualBtn: document.getElementById('saveManualBtn'),
    adminViewLeaderboard: document.getElementById('adminViewLeaderboard'),
    leaderboardArea: document.getElementById('leaderboardArea'),
    adminLeaderboard: document.getElementById('adminLeaderboard'),
    downloadAnimBtn: document.getElementById('downloadAnimBtn'),
    closeLogin: document.getElementById('closeLogin'),
    loginSection: document.getElementById('loginSection'),
    registrationSection: document.getElementById('registrationSection'),
    gameSection: document.getElementById('gameSection'),
    resultsSection: document.getElementById('resultsSection'),
    loginForm: document.getElementById('loginForm'),
    loginBtn: document.getElementById('loginBtn'),
    playerName: document.getElementById('playerName'),
    playerClub: document.getElementById('playerClub'),
    playerEmail: document.getElementById('playerEmail'),
    playerSchool: document.getElementById('playerSchool'),
    startGameBtn: document.getElementById('startGameBtn'),
    crosswordGrid: document.getElementById('crosswordGrid'),
    acrossClues: document.getElementById('acrossClues'),
    downClues: document.getElementById('downClues'),
    timer: document.getElementById('timer'),
    checkAnswersBtn: document.getElementById('checkAnswersBtn'),
    submitGameBtn: document.getElementById('submitGameBtn'),
    playerResult: document.getElementById('playerResult'),
    solutionBox: document.getElementById('solutionBox'),
    solutionGrid: document.getElementById('solutionGrid'),
    leaderboard: document.getElementById('leaderboardBody'),
    playAgainBtn: document.getElementById('playAgainBtn'),
    quizStatus: document.getElementById('quizStatus')
};

/* ---------------------- admin functions ---------------------- */
el.adminAccessBtn.addEventListener('click', () => el.overlay.classList.add('show'));
el.closeModal.addEventListener('click', () => el.overlay.classList.remove('show'));
el.closeLogin.addEventListener('click', () => el.overlay.classList.remove('show'));

el.adminLoginBtn.addEventListener('click', () => {
    const username = el.adminUsername.value.trim();
    const password = el.adminPassword.value.trim();
    if (username === config.adminCredentials.username && password === config.adminCredentials.password) {
        el.loginBlock.classList.add('hidden');
        el.adminControls.classList.remove('hidden');
        loadManualRows();
    } else {
        alert('Invalid admin credentials');
    }
});

el.adminLogoutBtn.addEventListener('click', () => {
    el.adminControls.classList.add('hidden');
    el.loginBlock.classList.remove('hidden');
    el.leaderboardArea.classList.add('hidden');
    el.adminUsername.value = '';
    el.adminPassword.value = '';
});

el.addRowBtn.addEventListener('click', () => {
    const row = document.createElement('div');
    row.className = 'manual-row';
    row.innerHTML = `
        <input type="text" placeholder="Word" />
        <input type="text" placeholder="Clue" />
        <select>
            <option value="easy">Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
        </select>
        <input type="text" placeholder="Category (optional)" />
        <button class="remove-row-btn small" style="background:#e74c3c;">X</button>
    `;
    row.querySelector('.remove-row-btn').addEventListener('click', () => row.remove());
    el.manualRows.appendChild(row);
});

el.saveManualBtn.addEventListener('click', () => {
    const rows = el.manualRows.querySelectorAll('.manual-row');
    const questions = [];
    rows.forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        if (inputs[0].value && inputs[1].value) {
            questions.push({
                word: inputs[0].value.trim().toUpperCase(),
                clue: inputs[1].value.trim(),
                difficulty: inputs[2].value,
                category: inputs[3].value.trim() || 'General'
            });
        }
    });
    if (questions.length) {
        localStorage.setItem(config.questionsKey, JSON.stringify(questions));
        alert(`Saved ${questions.length} questions!`);
    } else {
        alert('No valid questions to save');
    }
});

el.clearQuestionsBtn.addEventListener('click', () => {
    if (confirm('Are you sure you want to clear all questions?')) {
        localStorage.removeItem(config.questionsKey);
        el.manualRows.innerHTML = '';
        alert('Questions cleared');
    }
});

el.uploadCsvBtn.addEventListener('click', () => {
    const file = el.csvUpload.files[0];
    if (!file) return alert('Please select a CSV file first');
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const csv = e.target.result;
        const lines = csv.split('\n');
        const questions = [];
        
        for (let i = 1; i < lines.length; i++) {
            const cells = lines[i].split(',').map(c => c.trim());
            if (cells.length >= 2 && cells[0] && cells[1]) {
                questions.push({
                    word: cells[0].toUpperCase(),
                    clue: cells[1],
                    difficulty: cells[2] || 'easy',
                    category: cells[3] || 'General'
                });
            }
        }
        
        if (questions.length) {
            localStorage.setItem(config.questionsKey, JSON.stringify(questions));
            loadManualRows();
            alert(`Uploaded ${questions.length} questions from CSV!`);
        } else {
            alert('No valid questions found in CSV');
        }
    };
    reader.readAsText(file);
});

el.adminViewLeaderboard.addEventListener('click', () => {
    el.leaderboardArea.classList.toggle('hidden');
    if (!el.leaderboardArea.classList.contains('hidden')) {
        loadAdminLeaderboard();
    }
});

function loadManualRows() {
    const questions = JSON.parse(localStorage.getItem(config.questionsKey) || '[]');
    el.manualRows.innerHTML = '';
    questions.forEach(q => {
        const row = document.createElement('div');
        row.className = 'manual-row';
        row.innerHTML = `
            <input type="text" placeholder="Word" value="${q.word}" />
            <input type="text" placeholder="Clue" value="${q.clue}" />
            <select>
                <option value="easy" ${q.difficulty === 'easy' ? 'selected' : ''}>Easy</option>
                <option value="medium" ${q.difficulty === 'medium' ? 'selected' : ''}>Medium</option>
                <option value="hard" ${q.difficulty === 'hard' ? 'selected' : ''}>Hard</option>
            </select>
            <input type="text" placeholder="Category (optional)" value="${q.category || ''}" />
            <button class="remove-row-btn small" style="background:#e74c3c;">X</button>
        `;
        row.querySelector('.remove-row-btn').addEventListener('click', () => row.remove());
        el.manualRows.appendChild(row);
    });
}

function loadAdminLeaderboard() {
    const leaderboard = JSON.parse(localStorage.getItem(config.leaderboardKey) || '[]');
    const tbody = el.adminLeaderboard.querySelector('tbody');
    tbody.innerHTML = '';
    
    leaderboard.sort((a, b) => b.score - a.score || a.time - b.time)
        .forEach((entry, i) => {
            const tr = document.createElement('tr');
            const minutes = Math.floor(entry.time / 60);
            const seconds = entry.time % 60;
            tr.innerHTML = `
                <td>${i + 1}</td>
                <td>${entry.name}</td>
                <td>${entry.club || '-'}</td>
                <td>${entry.score}</td>
                <td>${minutes}:${seconds.toString().padStart(2, '0')}</td>
                <td>${new Date(entry.date).toLocaleDateString()}</td>
            `;
            tbody.appendChild(tr);
        });
}

/* ---------------------- login functions ---------------------- */
el.loginBtn.addEventListener('click', () => {
    const name = document.getElementById('loginName').value.trim();
    const email = document.getElementById('loginEmail').value.trim();
    const school = document.getElementById('schoolName').value.trim();
    const address = document.getElementById('schoolAddress').value.trim();
    const classStudying = document.getElementById('classStudying').value.trim();
    const parentName = document.getElementById('parentName').value.trim();
    const parentContact = document.getElementById('parentContact').value.trim();
    const club = document.getElementById('clubName').value.trim();

    if (!name || !email || !school || !address || !classStudying || !parentName || !parentContact) {
        alert('Please fill in all required fields');
        return;
    }

    // Check if user has already submitted within 24 hours
    const submissionRecords = JSON.parse(localStorage.getItem(config.submissionRecordsKey) || '{}');
    const userKey = email.toLowerCase();
    
    if (submissionRecords[userKey]) {
        const lastSubmission = new Date(submissionRecords[userKey]);
        const now = new Date();
        const hoursDiff = (now - lastSubmission) / (1000 * 60 * 60);
        
        if (hoursDiff < 24) {
            const hoursLeft = Math.ceil(24 - hoursDiff);
            alert(`You can only submit once every 24 hours. Please try again after ${hoursLeft} hours.`);
            return;
        }
    }

    // Check if user is already logged in (but hasn't submitted)
    const loginRecords = JSON.parse(localStorage.getItem(config.loginRecordsKey) || '{}');
    if (loginRecords[userKey]) {
        const lastLogin = new Date(loginRecords[userKey]);
        const now = new Date();
        const hoursDiff = (now - lastLogin) / (1000 * 60 * 60);
        
        if (hoursDiff < 24) {
            // Allow login if they haven't submitted yet
            proceedToRegistration(name, email, school, club);
            return;
        }
    }

    // First time login or 24 hours have passed
    proceedToRegistration(name, email, school, club);
    
    // Store login record (not submission record yet)
    loginRecords[userKey] = new Date().toISOString();
    localStorage.setItem(config.loginRecordsKey, JSON.stringify(loginRecords));
});

function proceedToRegistration(name, email, school, club) {
    gameState.player = { name, email, school, club };
    
    // Store login data for later submission
    const loginData = {
        name,
        email,
        school,
        address: document.getElementById('schoolAddress').value.trim(),
        classStudying: document.getElementById('classStudying').value.trim(),
        parentName: document.getElementById('parentName').value.trim(),
        parentContact: document.getElementById('parentContact').value.trim(),
        club,
        loginTime: new Date().toISOString()
    };
    
    gameState.loginData = loginData;
    
    // Update UI
    el.playerName.value = name;
    el.playerEmail.value = email;
    el.playerSchool.value = school;
    el.playerClub.value = club || 'Not specified';
    
    el.loginSection.classList.add('hidden');
    el.registrationSection.classList.remove('hidden');
    
    // Check if we have questions
    const questions = JSON.parse(localStorage.getItem(config.questionsKey) || '[]');
    if (questions.length === 0) {
        el.quizStatus.textContent = 'Quiz not available. Please contact administrator.';
        el.quizStatus.style.color = '#e74c3c';
        el.startGameBtn.disabled = true;
    } else {
        el.quizStatus.textContent = 'Quiz is ready!';
        el.quizStatus.style.color = '#2ecc71';
        el.startGameBtn.disabled = false;
    }
}

el.startGameBtn.addEventListener('click', () => {
    el.registrationSection.classList.add('hidden');
    el.gameSection.classList.remove('hidden');
    startGame();
});

/* ---------------------- game functions ---------------------- */
function startGame() {
    const questions = JSON.parse(localStorage.getItem(config.questionsKey) || '[]');
    if (questions.length === 0) {
        alert('No questions available. Please contact administrator.');
        return;
    }
    
    gameState.crossword = generateCrossword(questions, config.gridSize);
    renderCrossword(gameState.crossword);
    
    gameState.startTime = Date.now();
    gameState.timeElapsed = 0;
    updateTimer();
    gameState.timerInterval = setInterval(updateTimer, 1000);
}

function updateTimer() {
    gameState.timeElapsed = Math.floor((Date.now() - gameState.startTime) / 1000);
    const minutes = Math.floor(gameState.timeElapsed / 60);
    const seconds = gameState.timeElapsed % 60;
    el.timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function generateCrossword(words, gridSize) {
    // Sort by length (longest first for better placement)
    words = words.map(w => ({...w}));
    words.sort((a, b) => b.word.length - a.word.length);
    
    const grid = Array(gridSize).fill().map(() => Array(gridSize).fill(''));
    const placedWords = [];
    const across = [];
    const down = [];
    
    // Place first word in the center
    const firstWord = words.shift();
    const startRow = Math.floor((gridSize - firstWord.word.length) / 2);
    const startCol = Math.floor(gridSize / 2);
    
    for (let i = 0; i < firstWord.word.length; i++) {
        grid[startRow][startCol + i] = firstWord.word[i];
    }
    
    placedWords.push({
        word: firstWord.word,
        clue: firstWord.clue,
        row: startRow,
        col: startCol,
        direction: 'across',
        number: 1
    });
    across.push(placedWords[0]);
    
    let number = 2;
    
    // Try to place remaining words
    for (const wordData of words) {
        const word = wordData.word;
        let placed = false;
        
        // Try to place across
        for (let i = 0; i < word.length && !placed; i++) {
            for (const placedWord of placedWords) {
                for (let j = 0; j < placedWord.word.length && !placed; j++) {
                    if (word[i] === placedWord.word[j]) {
                        let row, col;
                        
                        if (placedWord.direction === 'across') {
                            row = placedWord.row - i;
                            col = placedWord.col + j;
                            
                            if (canPlaceDown(word, row, col, grid, placedWord)) {
                                placeWord(word, wordData.clue, row, col, 'down', grid, placedWords, down, number++);
                                placed = true;
                            }
                        } else {
                            row = placedWord.row + j;
                            col = placedWord.col - i;
                            
                            if (canPlaceAcross(word, row, col, grid, placedWord)) {
                                placeWord(word, wordData.clue, row, col, 'across', grid, placedWords, across, number++);
                                placed = true;
                            }
                        }
                    }
                }
            }
        }
    }
    
    return { grid, across, down };
}

function canPlaceDown(word, row, col, grid, ignoreWord) {
    if (row < 0 || row + word.length > grid.length) return false;
    
    for (let i = 0; i < word.length; i++) {
        const cell = grid[row + i]?.[col];
        
        // Check if cell is empty or matches the letter we want to place
        if (cell && cell !== word[i]) return false;
        
        // Check left neighbor (must be empty)
        if (col > 0 && !grid[row + i][col - 1] && (i === 0 || grid[row + i - 1][col])) {
            if (grid[row + i][col - 1] && !isPartOfWord(row + i, col - 1, ignoreWord)) return false;
        }
        
        // Check right neighbor (must be empty)
        if (col < grid.length - 1 && !grid[row + i][col + 1] && (i === 0 || grid[row + i - 1][col])) {
            if (grid[row + i][col + 1] && !isPartOfWord(row + i, col + 1, ignoreWord)) return false;
        }
    }
    
    // Check top and bottom
    if (row > 0 && grid[row - 1][col]) return false;
    if (row + word.length < grid.length && grid[row + word.length][col]) return false;
    
    return true;
}

function canPlaceAcross(word, row, col, grid, ignoreWord) {
    if (col < 0 || col + word.length > grid.length) return false;
    
    for (let i = 0; i < word.length; i++) {
        const cell = grid[row]?.[col + i];
        
        // Check if cell is empty or matches the letter we want to place
        if (cell && cell !== word[i]) return false;
        
        // Check top neighbor (must be empty)
        if (row > 0 && !grid[row - 1][col + i] && (i === 0 || grid[row][col + i - 1])) {
            if (grid[row - 1][col + i] && !isPartOfWord(row - 1, col + i, ignoreWord)) return false;
        }
        
        // Check bottom neighbor (must be empty)
        if (row < grid.length - 1 && !grid[row + 1][col + i] && (i === 0 || grid[row][col + i - 1])) {
            if (grid[row + 1][col + i] && !isPartOfWord(row + 1, col + i, ignoreWord)) return false;
        }
    }
    
    // Check left and right
    if (col > 0 && grid[row][col - 1]) return false;
    if (col + word.length < grid.length && grid[row][col + word.length]) return false;
    
    return true;
}

function isPartOfWord(row, col, word) {
    if (word.direction === 'across') {
        return row === word.row && col >= word.col && col < word.col + word.word.length;
    } else {
        return col === word.col && row >= word.row && row < word.row + word.word.length;
    }
}

function placeWord(word, clue, row, col, direction, grid, placedWords, directionList, number) {
    const wordObj = { word, clue, row, col, direction, number };
    placedWords.push(wordObj);
    directionList.push(wordObj);
    
    if (direction === 'across') {
        for (let i = 0; i < word.length; i++) {
            grid[row][col + i] = word[i];
        }
    } else {
        for (let i = 0; i < word.length; i++) {
            grid[row + i][col] = word[i];
        }
    }
}

function renderCrossword(crossword) {
    // Create grid HTML
    let gridHTML = '<table class="crossword">';
    for (let i = 0; i < config.gridSize; i++) {
        gridHTML += '<tr>';
        for (let j = 0; j < config.gridSize; j++) {
            const cell = crossword.grid[i][j];
            if (cell) {
                // Find if this cell has a number
                let number = '';
                for (const word of [...crossword.across, ...crossword.down]) {
                    if (word.row === i && word.col === j) {
                        number = `<span class="number">${word.number}</span>`;
                        break;
                    }
                }
                
                gridHTML += `<td>${number}<input type="text" class="cell" maxlength="1" data-row="${i}" data-col="${j}"></td>`;
            } else {
                gridHTML += '<td class="black"></td>';
            }
        }
        gridHTML += '</tr>';
    }
    gridHTML += '</table>';
    el.crosswordGrid.innerHTML = gridHTML;
    
    // Render clues
    el.acrossClues.innerHTML = '';
    crossword.across.forEach(word => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${word.number}.</strong> ${word.clue}`;
        el.acrossClues.appendChild(li);
    });
    
    el.downClues.innerHTML = '';
    crossword.down.forEach(word => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${word.number}.</strong> ${word.clue}`;
        el.downClues.appendChild(li);
    });
}

el.checkAnswersBtn.addEventListener('click', () => {
    checkAnswers(false);
});

el.submitGameBtn.addEventListener('click', () => {
    if (confirm('Are you sure you want to submit your answers? This will end the game.')) {
        checkAnswers(true);
    }
});

function checkAnswers(isFinalSubmit) {
    clearInterval(gameState.timerInterval);
    
    const cells = el.crosswordGrid.querySelectorAll('.cell');
    let correctCount = 0;
    let totalCount = 0;
    
    cells.forEach(cell => {
        const row = parseInt(cell.dataset.row);
        const col = parseInt(cell.dataset.col);
        const userInput = cell.value.toUpperCase();
        const correctAnswer = gameState.crossword.grid[row][col];
        
        if (correctAnswer) {
            totalCount++;
            if (userInput === correctAnswer) {
                correctCount++;
                cell.style.backgroundColor = '#d4edda';
            } else {
                cell.style.backgroundColor = '#f8d7da';
                if (isFinalSubmit) {
                    cell.value = correctAnswer;
                    cell.style.color = '#721c24';
                }
            }
        }
    });
    
    gameState.score = Math.round((correctCount / totalCount) * 100);
    gameState.checked = true;
    
    if (isFinalSubmit) {
        submitGame();
    }
}

function submitGame() {
    // Store submission record for 24-hour restriction
    const submissionRecords = JSON.parse(localStorage.getItem(config.submissionRecordsKey) || '{}');
    const userKey = gameState.player.email.toLowerCase();
    submissionRecords[userKey] = new Date().toISOString();
    localStorage.setItem(config.submissionRecordsKey, JSON.stringify(submissionRecords));
    
    // Remove login record since submission is complete
    const loginRecords = JSON.parse(localStorage.getItem(config.loginRecordsKey) || '{}');
    delete loginRecords[userKey];
    localStorage.setItem(config.loginRecordsKey, JSON.stringify(loginRecords));
    
    // Save to leaderboard
    const leaderboard = JSON.parse(localStorage.getItem(config.leaderboardKey) || '[]');
    leaderboard.push({
        name: gameState.player.name,
        email: gameState.player.email,
        club: gameState.player.club || '',
        school: gameState.player.school,
        score: gameState.score,
        time: gameState.timeElapsed,
        date: new Date().toISOString()
    });
    localStorage.setItem(config.leaderboardKey, JSON.stringify(leaderboard));
    
    // Save login data to spreadsheet
    saveLoginDataToSheet();
    
    // Show results
    showResults();
}

function saveLoginDataToSheet() {
    // This would normally use Google Apps Script to save to spreadsheet
    // For demo purposes, we'll just log it
    console.log('Saving login data:', gameState.loginData);
    
    // In a real implementation, you would use:
    // fetch(config.scriptURL, {
    //     method: 'POST',
    //     body: JSON.stringify(gameState.loginData)
    // });
}

function showResults() {
    el.gameSection.classList.add('hidden');
    el.resultsSection.classList.remove('hidden');
    
    // Show player result
    const minutes = Math.floor(gameState.timeElapsed / 60);
    const seconds = gameState.timeElapsed % 60;
    el.playerResult.innerHTML = `
        <p><strong>Name:</strong> ${gameState.player.name}</p>
        <p><strong>Score:</strong> ${gameState.score}%</p>
        <p><strong>Time:</strong> ${minutes}:${seconds.toString().padStart(2, '0')}</p>
    `;
    
    // Show solution
    renderSolution();
    
    // Show leaderboard
    const leaderboard = JSON.parse(localStorage.getItem(config.leaderboardKey) || '[]');
    el.leaderboardBody.innerHTML = '';
    
    leaderboard.sort((a, b) => b.score - a.score || a.time - b.time)
        .slice(0, 10)
        .forEach((entry, i) => {
            const tr = document.createElement('tr');
            const minutes = Math.floor(entry.time / 60);
            const seconds = entry.time % 60;
            tr.innerHTML = `
                <td>${i + 1}</td>
                <td>${entry.name}</td>
                <td>${entry.club || '-'}</td>
                <td>${entry.score}%</td>
                <td>${minutes}:${seconds.toString().padStart(2, '0')}</td>
                <td>${new Date(entry.date).toLocaleDateString()}</td>
            `;
            el.leaderboardBody.appendChild(tr);
        });
}

function renderSolution() {
    let solutionHTML = '<table class="crossword">';
    for (let i = 0; i < config.gridSize; i++) {
        solutionHTML += '<tr>';
        for (let j = 0; j < config.gridSize; j++) {
            const cell = gameState.crossword.grid[i][j];
            if (cell) {
                solutionHTML += `<td>${cell}</td>`;
            } else {
                solutionHTML += '<td class="black"></td>';
            }
        }
        solutionHTML += '</tr>';
    }
    solutionHTML += '</table>';
    el.solutionGrid.innerHTML = solutionHTML;
    el.solutionBox.style.display = 'block';
}

el.playAgainBtn.addEventListener('click', () => {
    el.resultsSection.classList.add('hidden');
    el.loginSection.classList.remove('hidden');
});

// Initialize
loadManualRows();
</script>
</body>
</html>
